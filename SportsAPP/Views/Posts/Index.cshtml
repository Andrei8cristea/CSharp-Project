@inject UserManager<ApplicationUser> UserManager
@model IEnumerable<SportsAPP.Models.Post>

@{
    ViewData["Title"] = "Postări Sports";
}

<div class="twitter-feed fade-in">
    <!-- Header -->
    <div class="twitter-header">
        <h5 class="mb-0 fw-bold">Feed Postări</h5>
    </div>

    <!-- Tweet Composer -->
    @if (User.IsInRole("User") || User.IsInRole("Admin"))
    {
        <div class="tweet-composer">
            <a asp-controller="Posts" asp-action="New" class="btn btn-primary w-100">
                <i class="bi bi-plus-circle me-2"></i>Postare Nouă
            </a>
        </div>
    }

    <!-- Alerts -->
    @if (TempData.ContainsKey("message"))
    {
        <div class="mx-3 mt-3">
            <div class="alert @(TempData.ContainsKey("messageType") ? TempData["messageType"] : "alert-success") alert-dismissible">
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <i class="bi bi-check-circle me-2"></i>@TempData["message"]
            </div>
        </div>
    }

    <!-- Tweets/Posts -->
    @if (Model.Any())
    {
        @foreach (var post in Model)
        {
            <div class="tweet">
                <div class="d-flex gap-3">
                    <!-- Avatar -->
                    <div>
                        @if (!string.IsNullOrEmpty(post.User?.ProfileImagePath))
                        {
                            <img src="@post.User.ProfileImagePath" class="tweet-avatar" alt="@post.User.FullName" />
                        }
                        else
                        {
                            <div class="tweet-avatar-placeholder">
                                <i class="bi bi-person-fill text-white"></i>
                            </div>
                        }
                    </div>

                    <!-- Content -->
                    <div class="flex-grow-1">
                        <!-- Header -->
                        <div class="tweet-header">
                            <a asp-controller="Users" asp-action="Show" asp-route-id="@post.UserId" class="tweet-author text-decoration-none">
                                @post.User?.FullName
                            </a>
                            <span class="tweet-time">· @post.Date.ToString("dd MMM")</span>
                            <span class="tweet-badge">@post.MediaType</span>
                        </div>

                        <!-- Title & Content -->
                        <div class="tweet-content">
                            <div class="tweet-title">@post.Title</div>
                            <div>@post.Content</div>
                        </div>

                        <!-- Media -->
                        @if (!string.IsNullOrEmpty(post.MediaPath))
                        {
                            <div class="tweet-media">
                                @if (post.MediaType == SportsAPP.Models.MediaType.Image)
                                {
                                    <img src="@post.MediaPath" alt="@post.Title" />
                                }
                                else if (post.MediaType == SportsAPP.Models.MediaType.Video)
                                {
                                    <video controls style="max-height: 500px;">
                                        <source src="@post.MediaPath" type="video/mp4">
                                        Browser-ul dvs. nu suportă video.
                                    </video>
                                }
                            </div>
                        }

                        <!-- Actions -->
                        <div class="tweet-actions">
                            <a asp-controller="Posts" asp-action="Show" asp-route-id="@post.Id" class="tweet-action">
                                <i class="bi bi-chat"></i>
                                <span>@post.Comments.Count</span>
                            </a>

                            @{
                                var currentUserId = UserManager.GetUserId(User);
                                var hasLiked = post.Likes.Any(l => l.UserId == currentUserId);
                            }

                            @if (User.Identity!.IsAuthenticated)
                            {
                                @if (hasLiked)
                                {
                                    <form method="post" asp-controller="Likes" asp-action="Unlike" asp-route-postId="@post.Id" asp-route-returnUrl="@Context.Request.Path" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="tweet-action border-0 bg-transparent" style="color: #f91880;">
                                            <i class="bi bi-heart-fill"></i>
                                            <span>@post.LikesCount</span>
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <form method="post" asp-controller="Likes" asp-action="Like" asp-route-postId="@post.Id" asp-route-returnUrl="@Context.Request.Path" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="tweet-action border-0 bg-transparent">
                                            <i class="bi bi-heart"></i>
                                            <span>@post.LikesCount</span>
                                        </button>
                                    </form>
                                }
                            }
                            else
                            {
                                <span class="tweet-stat">
                                    <i class="bi bi-heart"></i>
                                    <span>@post.LikesCount</span>
                                </span>
                            }

                            @if (User.IsInRole("Admin") || post.UserId == UserManager.GetUserId(User))
                            {
                                <a asp-controller="Posts" asp-action="Edit" asp-route-id="@post.Id" class="tweet-action warning">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                
                                <form method="post" asp-controller="Posts" asp-action="Delete" asp-route-id="@post.Id" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="tweet-action danger border-0 bg-transparent" onclick="return confirm('Sigur doriți să ștergeți această postare?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-5 px-3">
            <div class="mb-3">
                <i class="bi bi-people" style="font-size: 4rem; opacity: 0.3;"></i>
            </div>
            @if (ViewBag.IsFollowingAnyone == false && ViewBag.HasOwnPosts == false)
            {
                <h5>Feed-ul tău este gol!</h5>
                <p class="text-muted mb-3">
                    Urmărește pe cineva pentru a vedea postările lor aici. <br />
                    Sau creează-ți prima postare!
                </p>
                <a asp-controller="Users" asp-action="Index" class="btn btn-primary me-2">
                    <i class="bi bi-person-plus me-1"></i> Găsește utilizatori
                </a>
                <a asp-controller="Posts" asp-action="New" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-1"></i> Postare nouă
                </a>
            }
            else if (ViewBag.HasOwnPosts == true && ViewBag.IsFollowingAnyone == false)
            {
                <h5>Nu există alte postări</h5>
                <p class="text-muted mb-3">
                    Urmărește pe cineva pentru a vedea mai multe postări!
                </p>
                <a asp-controller="Users" asp-action="Index" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i> Găsește utilizatori
                </a>
            }
            else
            {
                <h5>Nu există postări încă</h5>
                <p class="text-muted">Persoanele pe care le urmărești nu au postat nimic recent.</p>
            }
        </div>
    }
</div>
